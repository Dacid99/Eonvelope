image: python:3.13-alpine

default:
  interruptible: true
  before_script:
    - set -o pipefail
    - export SECRET_KEY='HELPER_KEY'
    - export PYTHONPATH='src'
    - export DJANGO_SETTINGS_MODULE='Emailkasten.settings'
    - apk update && apk add --no-cache ${APK_DEPENDENCIES}
    - pip install poetry
    - poetry install --with dev

workflow:  # when the pipeline should be triggered
  rules:  # collect all rules from the jobs here
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "schedule"

variables:
  CI: "true"
  GITLAB_API_URL: "https://gitlab.com/-/project/$CI_PROJECT_ID"
  APK_DEPENDENCIES: "gettext \
    python3-dev \
    linux-headers \
    musl-dev \
    gcc \
    build-base \
    mariadb-connector-c-dev \
    mariadb-dev \
    mariadb-client"
  CHECK_PATH: "tools/"
  CHECK_CONFIG_PATH: "tools/"
  CHECK_REPORT_PATH: "tools/reports/"
  TEST_PATH: "test/"
  TEST_CONFIG_PATH: "test/"
  TEST_REPORT_PATH: "test/reports/"
  DOCKER_PATH: "docker/"
  DOCKER_IMAGE_PATH: "/var/lib/docker/image/overlay2/"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

services:
  - docker:dind

stages:
  - dependabot
  - check_version
  - check_fixes_and_format
  - lint
  - test
  - build

include:
  - local: .gitlab/ci/.gitlab-ci-dependabot.yml
  - local: .gitlab/ci/.gitlab-ci-check-version.yml
  - local: .gitlab/ci/.gitlab-ci-fix_and_format.yml
  - local: .gitlab/ci/.gitlab-ci-lint.yml
  - local: .gitlab/ci/.gitlab-ci-test.yml
  - local: .gitlab/ci/.gitlab-ci-build.yml
  - local: .gitlab/ci/.gitlab-ci-debug-build.yml
